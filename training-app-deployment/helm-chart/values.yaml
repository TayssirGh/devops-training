app: myapp


services:
  - backend:
    name: backend-service
    namespace: training-app-backend-prod
    type: LoadBalancer
    app: myapp
    port: 9099
    targetPort: 3000
  - frontend:
    name: frontend-service
    namespace: training-app-frontend-prod
    type: LoadBalancer
    app: myapp
    port: 80
    targetPort: 80

deployments:
  - backend:
    name: back-dep
    namespace: training-app-backend-prod
    app: myapp
    apps:
      - node:
        container:
          name: backend-training
          image: xqliza/t005-backend:dev
          imagePullPolicy: Always
          ports:
            containerPort: 3000
          env:
            - name: APP_PORT
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: APP_PORT
            - name: QR_URL
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: QR_URL
            - name: MONGO_URI
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: MONGO_URI
            - name: MONGO_DB
              valueFrom:
                secretKeyRef:
                  name: backend-secret
                  key: MONGO_DB
 
      - qr:
        container:
          name: qr-training
          image: xqliza/t005-qr:dev
          imagePullPolicy: Always
          ports:
            containerPort: 8420
          env:
            - name: USE_BUCKET
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: USE_BUCKET
            - name: BUCKET_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: BUCKET_ENDPOINT
            - name: BUCKET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: BUCKET_ACCESS_KEY
            - name: BUCKET_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: BUCKET_SECRET_KEY
            - name: BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: BUCKET_NAME
            - name: BUCKET_PATH
              valueFrom:
                secretKeyRef:
                  name: qr-secret
                  key: BUCKET_PATH 

  - frontend:
    name: front-dep
    namespace: training-app-frontend-prod
    app: myapp
    apps:
      - front:
        container:
          name: website-training
          image: xqliza/t005-website:dev
          imagePullPolicy: Always
          ports:
            containerPort: 80
          volumeMounts:
              mountPath: "/usr/share/nginx/html/assets/configs"
              name: frontconfig-volume
        volumes:
          - configMap:
              name: frontconfig
            name: frontconfig-volume

ingresses:
  - frontend:
    name: ingress-frontservice
    namespace: training-app-frontend-prod
    host: localhost
    path: /
    pathType: Prefix
    service:
      name: frontend-service
      port: 80
    ingressClassName: nginx
  - backend:
    name: ingress-backend
    namespace: training-app-backend-prod
    annotations:
      use-regex: "true"
      rewrite-target: /$2
    host: localhost
    path: /api(/|$)(.*)
    pathType: Prefix
    service:
      name: backend-service
      port: 9099
    ingressClassName: nginx

configmaps:
  - frontconfig:
    name: frontconfig
    namespace: training-app-frontend-prod
    filepath: configfiles/app-config.json
    filename: app-config.json

namespaces:
  backend: training-app-backend-prod
  frontend: training-app-frontend-prod

secrets:
  - backend:
    name: backend-secret
    namespace: training-app-backend-prod
    values:
      APP_PORT: 3000
      QR_URL: http://localhost:8420/
      MONGO_URI: ENV_T005_MONGO_URI
      MONGO_DB: qrs

  - qr:
    name: qr-secret
    namespace: training-app-backend-prod
    values:
      USE_BUCKET: "true"
      BUCKET_ENDPOINT: ENV_PUBLIC_BUCKET_ENDPOINT
      BUCKET_ACCESS_KEY: ENV_PUBLIC_BUCKET_ACCESS_KEY
      BUCKET_SECRET_KEY: ENV_PUBLIC_BUCKET_SECRET_KEY
      BUCKET_NAME: testbucketio
      BUCKET_PATH: /data