version: "3.9"
services:

 
  qr:
    image: housseinhmila/t-007-qr:v1.0.0
    
    build:
      context: ./qr
    restart: always
    deploy:
     
      replicas: 2
    ports: 
      - 8420
    env_file:
      - qr/.env
    #environment:
    #  - QR_TMP_FOLDER="./generated_qr"
    #  - QR_FILL_COLOR="#121128"
    #  - QR_BACKGROUND_COLOR="#dcdbdb"
    #  - USE_BUCKET=true
    #  - BUCKET_ENDPOINT="myminio:9000"
    #  - BUCKET_ACCESS_KEY="7A0bbzvFVmsJkx2Irqcw"
    #  - BUCKET_SECRET_KEY="FDLGkVgOpek5g91OQVTPRgjjiyAK4gYKButkZ7kf"
    #  - BUCKET_NAME="test"
    #  - BUCKET_PATH=""
    depends_on:
      - minio
    volumes:
      - generated_qr:/app/generated_qr/
    networks:
      - qr_network

  backend:
    image: housseinhmila/t-007-backend:v1.0.0
    
    build:
      context: ./backend
    restart: always
    ports: 
     - 3000
    deploy:
      mode: replicated
      replicas: 2
    depends_on:
      - qr
    env_file:
      - backend/.env
    networks:
      - qr_network
      - app_network
    #environment:
    #  - APP_PORT=3000
    #  - QR_URL=http://qr:8420
    #  - MONGO_URI="${T007_MONGO_URI}"
    #  - MONGO_DB=test

    

  website:
    image: housseinhmila/t-007-website:v1.0.0
    build:
      context: ./website
    restart: always
    deploy:
      mode: replicated
      replicas: 2
    ports: 
     - 4200
    depends_on:
      - backend
    volumes:
    - generated_qr:/etc/nginx/html/assets/data
   
  

    networks:
      - app_network

  minio:
    image: minio/minio
    container_name: myminio
    environment:
      - MINIO_ROOT_USER=strass
      - MINIO_ROOT_PASSWORD=strass22
    command: server /data --console-address ":9001"
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - ./minio_data:/data
    networks:
      - qr_network
      - app_network

  load_balancer:
    image: nginx:latest
    container_name: load_balancer
    ports:
      - 80:80
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - generated_qr:/etc/nginx/html/assets/data

    networks:
      - qr_network
      - app_network
    depends_on:
      - website
      - backend
      - minio
      - qr


volumes:
  generated_qr:
  minio_data:
  
 

networks:
  app_network:
  qr_network:
