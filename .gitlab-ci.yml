stages:
  - build_deploy

variables:
  WORKING_BRANCH: t-010-dev
  IMAGE_QR: qr
  IMAGE_BACKEND: backend-1.0
  IMAGE_WEBSITE: website-1.0
  DOCKER_HUB_REPO: khalilmk/devops-training

build:
  stage: build_deploy
  
  image: docker:20.10.12
  
  services:
    - docker:20.10.12-dind
  
  variables:
    DOCKER_TLS_CERTDIR: "/certs"

  before_script:
    - chmod +x load_env_variables.sh
    - ./load_env_variables.sh
    - set BUCKET_ACCESS_KEY=$PUBLIC_BUCKET_ACCESS_KEY
    - set BUCKET_SECRET_KEY=$PUBLIC_BUCKET_SECRET_KEY
    - set MONGO_URI=$T007_MONGO_URL
    - chmod +x applications/configure-tls.sh
    - sh ./applications/configure-tls.sh
    - docker login -u $T10_REGISTRY_USER -p $T10_REGISTRY_PASS
      
  script:
    - chmod +x ./applications/launch-D.sh
    - sh ./applications/launch-D.sh
  only:
    variables:
      - $WORKING_BRANCH == "t-010-dev"
  tags:
    - t010-build-protected

